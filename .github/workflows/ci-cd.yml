name: CI/CD Pipeline

on:
  pull_request:
    types: [closed]
    branches: ["main"]
  push:
    branches: ["main"]
    tags: ["v*"]

env:
  PYTHON_VERSION: "3.11"
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  REDIS_URL: ${{ secrets.REDIS_URL }}
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

jobs:
  # Linter job
  lint:
    name: Lint (black, isort, flake8)
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8

      - name: Run Black (check)
        run: black --check src tests

      - name: Run isort (check)
        run: isort --profile black --check-only src tests

      - name: Run flake8
        run: flake8 --max-line-length=120 --extend-ignore=E203,W503,E501 --exclude=venv,env,migrations,__pycache__,.pytest_cache src tests

  # Test job
  tests:
    name: Tests + Coverage
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov fakeredis httpx

      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=30 -v

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
        if: always()

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        if: always()

  # Security scan job
  security:
    name: Security Scan
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit security scan
        run: bandit -r src -f html -o bandit-report.html || true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.html
        if: always()

  # Deploy job
  deploy:
    name: Deploy to Render
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: [tests, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render Deploy Hook
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "Triggering Render deployment..."
          curl -X POST "$RENDER_DEPLOY_HOOK"
          echo "Deployment triggered successfully!"

  # Health check job
  healthcheck:
    name: Health Check on Render
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for deployment to start
        run: sleep 30

      - name: Health Check
        env:
          HEALTHCHECK_URL: ${{ secrets.RENDER_HEALTHCHECK_URL }}
        run: |
          echo "Waiting for production health check..."
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTHCHECK_URL" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "✅ Service is healthy! HTTP Status: $STATUS"

              # Additional detailed health check
              RESPONSE=$(curl -s "$HEALTHCHECK_URL")
              echo "Health check response: $RESPONSE"

              exit 0
            fi
            echo "⏳ Still waiting... ($i/30) - Current status: $STATUS"
            sleep 10
          done
          echo "❌ Service did not pass healthcheck after 5 minutes!"
          exit 1
